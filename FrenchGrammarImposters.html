<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Grammar Impostors</title>
    <link rel="stylesheet" href="FrenchGrammarImposters.css">
</head>
<body>
    <h1 class="game-title">French Grammar Impostors</h1>
    <div class="version">Version 3.0</div>
    
    <div class="voting-area">
        <div class="vote-title">üö® R√©union d'urgence! üö®</div>
        <p id="voteInstructions">Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.</p>
        <div id="voteButtons"></div>
    </div>



    <div class="crewmates-area" id="crewmatesArea"></div>

    <button class="new-game-btn" onclick="startNewGame()">Nouvelle Partie</button>

    <script>
        const phrasePairs = [
            { correct: "Lundi, j'ai un match de soccer.", impostor: "Sur lundi, j'ai un match de soccer." },
            { correct: "J'ai regard√© un film √† la t√©l√©vision.", impostor: "J'ai regard√© un film sur la t√©l√©vision." },
            { correct: "Je n'ai pas de crayon.", impostor: "Je n'ai pas un crayon." },
            { correct: "J'ai chaud. Est-ce que je peux avoir un verre d'eau?", impostor: "Je suis chaud. Est-ce que je peux avoir un verre de l'eau?" },
            { correct: "Qu'est-ce que tu fais ici? Oh, rien du tout!", impostor: "Quoi est-ce que tu fais ici? Oh, rien!" },
            { correct: "Quelle heure est-il?", impostor: "Quel temps est-il?" },
            { correct: "Je vais chez le m√©decin.", impostor: "Je vais au m√©decin." },
            { correct: "Je suis all√© √† Victoria.", impostor: "J'ai all√© √† Victoria." },
            { correct: "J'ai peur et j'ai froid.", impostor: "J'ai peur et je suis froid." },
            { correct: "Je l'aime parce qu'il est le meilleur.", impostor: "Je l'aime lui parce qu'il est le meilleur." },            
        ];


        const crewmateData = [
            {name: 'Rouge', color: '#D71E22'}, {name: 'Bleu', color: '#1D3CE9'},
            {name: 'Vert', color: '#1B913E'}, {name: 'Rose', color: '#FF63D4'},
            {name: 'Orange', color: '#FF8D1C'}, {name: 'Jaune', color: '#FFFF67'},
            {name: 'Noir', color: '#4A565E'}, {name: 'Blanc', color: '#E9F7FF'},
            {name: 'Violet', color: '#783DD2'}, {name: 'Marron', color: '#80582D'},
            {name: 'Cyan', color: '#44FFF7'}, {name: 'Citron', color: '#5BFE4B'},
            {name: 'Bordeaux', color: '#6C2B3D'}, {name: 'Chair', color: '#FFD6EC'},
            {name: 'Banane', color: '#FFFFBE'}
        ];

        const violentDeathPhrases = [
            "ARGH!",
            "GLOUPS!",
            "A√èEEE!",
            "OUGH!",
            "URGH!",
            "TCHAC!"
        ];

        const innocentEjectionPhrases = [
            "Non, pas moi!",
            "Je suis innocent!",
            "Vous vous trompez!",
            "J'esp√®re que les aliens sont sympas!",
            "Mais j'ai fait toutes mes t√¢ches!",
            "Vous le regretterez!",
            "Ce n'√©tait pas moi, je vous jure!",
            "Houston, on a un probl√®me!",
            "Eventuellement, j'ai arr√™t√© de penser...",
            "Dites √† ma famille que je les aime!",
            "C'√©tait pas moi, je le jure!",
            "That was kinda sus.",
            "it wasn't me :("
        ];

        const imposterEjectionPhrases = [
            "Au moins, je vais voir les √©toiles!",
            "Je reviendrai!",
            "√Ä bient√¥t, astronautes!",
            "Vive la gravit√© z√©ro!",
            "J'aurais d√ª rester au lit!",
            "Vous avez eu de la chance cette fois!",
            "Bien jou√©, les terriens!",
            "L'espace, me voil√†!",
            "Ma mission est accomplie!",
            "Merci pour cette partie!",
            "On se revoit dans l'espace infini!",
            "GG les amis!",
            "Eventuellement, Kars a arr√™t√© de penser..."
        ];

        function getRandomDeathPhrase(deathType) {
            let phrases;
            switch(deathType) {
                case 'violent':
                    phrases = violentDeathPhrases;
                    break;
                case 'innocent_ejected':
                    phrases = innocentEjectionPhrases;
                    break;
                case 'impostor_ejected':
                    phrases = imposterEjectionPhrases;
                    break;
                default:
                    phrases = violentDeathPhrases;
            }
            return phrases[Math.floor(Math.random() * phrases.length)];
        }

        let gameState = { crewmates: [], impostors: [], round: 1, gameOver: false, currentDeadCrewmate: -1, currentEjectedCrewmate: -1, isRevealing: false, votingPhase: 'between_rounds', hasVoted: false, showingResults: false };
        let audioContext = null, clickBuffer = null;

        function initAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function createClickBuffer() {
            if (!audioContext || clickBuffer) return clickBuffer;
            const bufferSize = audioContext.sampleRate * 0.02;
            clickBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = clickBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                if (i < bufferSize * 0.1) output[i] = (Math.random() * 2 - 1) * Math.pow((bufferSize * 0.1 - i) / (bufferSize * 0.1), 2);
                else if (i < bufferSize * 0.3) output[i] = (Math.random() * 2 - 1) * 0.3 * Math.pow((bufferSize * 0.3 - i) / (bufferSize * 0.2), 3);
                else output[i] = 0;
            }
            return clickBuffer;
        }

        function scheduleClick(time) {
            if (!audioContext || !clickBuffer) return;
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            source.buffer = clickBuffer;
            filter.type = 'highpass';
            filter.frequency.value = 2000;
            filter.Q.value = 1;
            gainNode.gain.value = 0.15;
            source.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start(time);
        }

        function revealTextWithSync(element, text, onComplete) {
            if (gameState.isRevealing) return;
            gameState.isRevealing = true;
            initAudio();
            createClickBuffer();
            element.innerHTML = '<span class="reveal-text"></span>';
            const textSpan = element.querySelector('.reveal-text');
            const charTimings = [];
            let currentTime = 0;
            for (let i = 0; i < text.length; i++) {
                charTimings.push(currentTime);
                currentTime += (i >= 2 && text[i] === '.' && text[i-1] === '.' && text[i-2] === '.' && i < text.length - 1) ? 1200 : 60;
            }
            if (audioContext) {
                const startTime = audioContext.currentTime + 0.1;
                for (let i = 0; i < text.length; i++) scheduleClick(startTime + charTimings[i] / 1000);
            }
            let startTimestamp = null, currentIndex = 0;
            function animate(timestamp) {
                if (!startTimestamp) startTimestamp = timestamp;
                const elapsed = timestamp - startTimestamp;
                while (currentIndex < text.length && elapsed >= charTimings[currentIndex]) {
                    textSpan.innerHTML = text.substring(0, ++currentIndex);
                }
                if (currentIndex < text.length) requestAnimationFrame(animate);
                else { gameState.isRevealing = false; if (onComplete) onComplete(); }
            }
            requestAnimationFrame(animate);
        }

        function initializeGame() {
            gameState = { crewmates: [], impostors: [], round: 1, gameOver: false, currentDeadCrewmate: -1, currentEjectedCrewmate: -1, isRevealing: false, votingPhase: 'between_rounds', hasVoted: false, showingResults: false };
            document.querySelector('.vote-title').innerHTML = 'French Grammar Impostors';
            document.getElementById('voteInstructions').innerHTML = 'Initializing game...';
            const shuffledPairs = [...phrasePairs].sort(() => Math.random() - 0.5);
            const shuffledCrewmateData = [...crewmateData].sort(() => Math.random() - 0.5);

            // Track which phrase pairs are used by crewmates
            const usedPairIndices = new Set();

            // Assign 10 crewmates, each with a different phrase pair
            for (let i = 0; i < 10; i++) {
                gameState.crewmates.push({
                    id: i, phrase: shuffledPairs[i].correct, isImpostor: false,
                    alive: true, ejected: false, color: shuffledCrewmateData[i].color,
                    name: shuffledCrewmateData[i].name, pairIndex: i
                });
                usedPairIndices.add(i);
            }

            // Create list of unused pairs for impostor priority assignment
            const unusedPairIndices = [];
            for (let i = 10; i < shuffledPairs.length; i++) {
                unusedPairIndices.push(i);
            }

            // Shuffle unused pairs for random selection
            unusedPairIndices.sort(() => Math.random() - 0.5);

            // Assign 5 impostors using the prioritized system
            for (let impostorIndex = 0; impostorIndex < 5; impostorIndex++) {
                const crewmateId = 10 + impostorIndex;
                let pairIndex;

                // Priority 1: Use unused pairs if available
                if (unusedPairIndices.length > 0) {
                    pairIndex = unusedPairIndices.pop();
                } else {
                    // Priority 2: Reuse pairs already assigned to crewmates
                    const usedIndicesArray = Array.from(usedPairIndices);
                    pairIndex = usedIndicesArray[Math.floor(Math.random() * usedIndicesArray.length)];
                }

                gameState.crewmates.push({
                    id: crewmateId, phrase: shuffledPairs[pairIndex].impostor,
                    correctPhrase: shuffledPairs[pairIndex].correct, isImpostor: true,
                    alive: true, ejected: false, color: shuffledCrewmateData[crewmateId].color,
                    name: shuffledCrewmateData[crewmateId].name, pairIndex: pairIndex
                });
                gameState.impostors.push(crewmateId);
            }

            updateDisplay();

            // Start the first emergency meeting after a brief delay
            setTimeout(startFirstEmergencyMeeting, 1000);
        }

        function startFirstEmergencyMeeting() {
            // Kill a random innocent crewmate first
            const aliveInnocents = gameState.crewmates.filter(c => c.alive && !c.ejected && !c.isImpostor);
            if (aliveInnocents.length > 0) {
                const victim = aliveInnocents[Math.floor(Math.random() * aliveInnocents.length)];
                victim.alive = false;
                victim.deathPhrase = getRandomDeathPhrase('violent');
                gameState.currentDeadCrewmate = victim.id;

                // Show the emergency meeting with dead crewmate info
                document.querySelector('.vote-title').innerHTML = 'üö® R√©union d\'urgence! üö®';
                document.getElementById('voteInstructions').innerHTML = `A crewmate has been killed!<br><br>
                    <div class="dead-crewmate-display">
                        <div class="dead-crewmate-body-small" style="background-color: ${victim.color}">‚ò†Ô∏è</div>
                        <strong>${victim.name}</strong>
                    </div><br>
                    Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>
                    Votez pour √©liminer celui que vous pensez √™tre un imposteur.`;

                // Play emergency meeting sound
                playEmergencyMeetingSound();

                // Enable voting
                gameState.hasVoted = false;
                gameState.votingPhase = 'emergency_meeting';

                // Update vote buttons area
                document.getElementById('voteButtons').innerHTML = '<p>Cliquez sur le bouton sous chaque personnage pour voter pour l\'√©liminer!</p>';

                updateDisplay();
            }
        }

        function updateDisplay() {
            const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
            const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;

            const crewmatesArea = document.getElementById('crewmatesArea');
            const votingDisabled = gameState.votingPhase !== 'emergency_meeting' || gameState.hasVoted;
            crewmatesArea.innerHTML = gameState.crewmates.map(c => {
                // Determine speech bubble content and styling
                let speechContent = c.phrase;
                let isRecentlyDead = false;

                if (!c.alive && !c.ejected) {
                    // This crewmate is dead (killed by impostor)
                    if (c.id === gameState.currentDeadCrewmate) {
                        // This is the most recently killed crewmate - show death phrase
                        speechContent = c.deathPhrase || c.phrase;
                        isRecentlyDead = true;
                    } else {
                        // This is an old dead crewmate - speech will be hidden by CSS
                        speechContent = c.phrase;
                    }
                } else if (c.ejected) {
                    // This crewmate is ejected (voted out)
                    if (c.id === gameState.currentEjectedCrewmate) {
                        // This is the most recently ejected crewmate - show death phrase
                        speechContent = c.deathPhrase || c.phrase;
                        isRecentlyDead = true;
                    } else {
                        // This is an old ejected crewmate - speech will be hidden by CSS
                        speechContent = c.phrase;
                    }
                }

                return `
                <div class="crewmate ${c.alive ? 'alive' : 'dead'} ${c.ejected ? 'ejected' : ''} ${isRecentlyDead ? 'recently-dead' : ''}">
                    <div class="crewmate-body" style="background-color: ${c.color}">
                        ${c.alive && !c.ejected ? 'üë§' : (c.ejected ? 'üíÄ' : '‚ò†Ô∏è')}
                    </div>
                    <div class="speech-bubble">${speechContent}</div>
                    <button class="vote-btn ${votingDisabled ? 'voting-disabled' : ''}"
                        style="background-color: ${c.color}; color: ${c.color === '#FFFFFF' || c.color === '#F5F557' ? '#000' : '#FFF'}"
                        onclick="vote(${c.id})" ${!c.alive || c.ejected || gameState.isRevealing || gameState.gameOver ? 'disabled' : ''}>
                        Voter ${c.name}
                    </button>
                </div>
                `;
            }).join('');

            const voteButtons = document.getElementById('voteButtons');
            const voteInstructions = document.getElementById('voteInstructions');
            if (gameState.gameOver) {
                voteButtons.innerHTML = '<p style="color: #4ecdc4;">Jeu termin√© - Aucun vote disponible</p>';
            } else if (gameState.isRevealing) {
                voteButtons.innerHTML = '';
            } else if (gameState.showingResults) {
                // Don't clear vote buttons when showing results - preserve the emergency button
            } else {
                if (gameState.currentDeadCrewmate !== -1) {
                    const dead = gameState.crewmates[gameState.currentDeadCrewmate];
                    voteInstructions.innerHTML = `Un co√©quipier est mort !<div class="dead-crewmate-display">
                        <div class="dead-crewmate-body-small" style="background-color: ${dead.color}">‚ò†Ô∏è</div>
                        <div style="color: ${dead.color === '#FFFFFF' || dead.color === '#F5F557' ? '#000' : '#FFF'}; font-weight: bold;">${dead.name}</div>
                    </div>Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.`;
                } else {
                    voteInstructions.innerHTML = 'Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.';
                }
                voteButtons.innerHTML = '';
            }
            checkGameEnd();
        }

        function vote(crewmateId) {
            if (gameState.isRevealing || gameState.gameOver || gameState.hasVoted || gameState.votingPhase !== 'emergency_meeting') return;
            gameState.hasVoted = true;
            gameState.votingPhase = 'vote_results';
            const votedCrewmate = gameState.crewmates[crewmateId];
            votedCrewmate.ejected = true;
            votedCrewmate.deathPhrase = getRandomDeathPhrase(votedCrewmate.isImpostor ? 'impostor_ejected' : 'innocent_ejected');
            gameState.currentEjectedCrewmate = crewmateId;
            updateDisplay();
            startSuspensefulReveal(votedCrewmate);
        }

        function startSuspensefulReveal(votedCrewmate) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.querySelector('.vote-title').innerHTML = 'üìä R√©sultats du vote';

            // Show the standard voting message immediately with Next button
            document.getElementById('voteInstructions').innerHTML = 'Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.';

            // Show the Next button with stats
            const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
            const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;

            document.getElementById('voteButtons').innerHTML = `
                <br><button class="emergency-meeting-btn" onclick="revealVotingResults(${votedCrewmate.id})"><img src="Emergency_button.png" alt="Emergency Meeting Button"></button>
                <br><br>
                <div class="game-stats">
                    <div class="stat">Imposteurs: <span id="impostorsLeft">${aliveImpostors}</span></div>
                    <div class="stat">Co√©quipiers: <span id="crewmatesLeft">${aliveInnocents}</span></div>
                    <div class="stat">Manche: <span id="round">${gameState.round}</span></div>
                </div>
            `;
        }

        function revealVotingResults(crewmateId) {
            const votedCrewmate = gameState.crewmates[crewmateId];

            let revealText = votedCrewmate.isImpostor
                ? `"${votedCrewmate.phrase}" utilise la grammaire anglaise...<br>Le fran√ßais correct est : "${votedCrewmate.correctPhrase}"...<br>${votedCrewmate.name} √©tait un imposteur.`
                : `"${votedCrewmate.phrase}" utilise les r√®gles de grammaire fran√ßaise...<br>${votedCrewmate.name} n'√©tait pas un imposteur.`;

            revealTextWithSync(document.getElementById('voteInstructions'), revealText, () => {
                if (votedCrewmate.isImpostor) gameState.impostors = gameState.impostors.filter(id => id !== votedCrewmate.id);
                gameState.round++;
                gameState.currentDeadCrewmate = -1;
                gameState.currentEjectedCrewmate = -1;
                gameState.votingPhase = 'between_rounds';
                gameState.showingResults = true;  // Set flag to preserve emergency button

                // Update the stats with actual values and make the button call startEmergencyMeeting
                const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
                const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;

                document.getElementById('voteButtons').innerHTML = `
                    <br><button class="emergency-meeting-btn" onclick="startEmergencyMeeting()"><img src="Emergency_button.png" alt="Emergency Meeting Button"></button>
                    <br><br>
                    <div class="game-stats">
                        <div class="stat">Imposteurs: <span id="impostorsLeft">${aliveImpostors}</span></div>
                        <div class="stat">Co√©quipiers: <span id="crewmatesLeft">${aliveInnocents}</span></div>
                        <div class="stat">Manche: <span id="round">${gameState.round}</span></div>
                    </div>
                `;
                updateDisplay();
            });
        }

        function killNextCrewmate() {
            const aliveInnocents = gameState.crewmates.filter(c => c.alive && !c.ejected && !c.isImpostor);
            if (aliveInnocents.length > 0) {
                const victim = aliveInnocents[Math.floor(Math.random() * aliveInnocents.length)];
                victim.alive = false;
                victim.deathPhrase = getRandomDeathPhrase('violent');
                gameState.currentDeadCrewmate = victim.id;
            }
        }

        function checkGameEnd() {
            const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
            const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;
            const voteTitle = document.querySelector('.vote-title');
            const voteInstructions = document.getElementById('voteInstructions');
            
            if (aliveImpostors === 0) {
                voteTitle.innerHTML = 'üéâ Victory!';
                voteInstructions.innerHTML = 'You found all the grammar impostors! Hugo has saved the French language!<br><br><button class="new-game-btn" onclick="startNewGame()">Nouvelle Partie</button>';
                gameState.gameOver = true;
            } else if (aliveImpostors >= aliveInnocents) {
                voteTitle.innerHTML = 'üíÄ Game Over!';
                voteInstructions.innerHTML = `The grammar impostors have taken over! The remaining impostors were: ${gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).map(c => c.name).join(', ')}<br><br><button class="new-game-btn" onclick="startNewGame()">Nouvelle Partie</button>`;
                gameState.gameOver = true;
            }
        }

        function startEmergencyMeeting() {
            // Play emergency meeting sound
            playEmergencyMeetingSound();

            // Reset voting state and enable voting
            gameState.hasVoted = false;
            gameState.votingPhase = 'emergency_meeting';
            gameState.showingResults = false;  // Reset flag when starting new meeting

            // Kill next crewmate and start new round
            killNextCrewmate();
            document.querySelector('.vote-title').innerHTML = 'üö® R√©union d\'urgence! üö®';
            document.getElementById('voteButtons').innerHTML = '<p>Cliquez sur le bouton sous chaque personnage pour voter pour l\'√©liminer!</p>';
            updateDisplay();
        }

        function playEmergencyMeetingSound() {
            // Try to play the EmergencyMeetingSound.mp3 file
            const audio = new Audio('EmergencyMeetingSound.mp3');
            audio.volume = 0.5;
            audio.play().catch(error => {
                console.log('Could not play emergency meeting sound:', error);
            });
        }

        function startNewGame() { initializeGame(); }
        document.addEventListener('click', () => { if (audioContext && audioContext.state === 'suspended') audioContext.resume(); });
        initializeGame();
    </script>
</body>
</html>
<!-- Streamlined from 733 lines to 297 lines on 2025-09-25 -->