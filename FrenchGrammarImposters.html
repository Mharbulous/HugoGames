<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Grammar Impostors</title>
    <link rel="stylesheet" href="FrenchGrammarImposters.css">
</head>
<body>
    <h1 class="game-title">French Grammar Impostors</h1>
    <div class="version">Version 3.1</div>
    
    <div class="voting-area">
        <div class="vote-title">üö® R√©union d'urgence! üö®</div>
        <p id="voteInstructions">Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.</p>
        <div id="voteButtons"></div>
    </div>



    <div class="crewmates-area" id="crewmatesArea"></div>

    <button class="new-game-btn" onclick="startNewGame()">Nouvelle Partie</button>

    <script>
        const phrasePairs = [
            { correct: "Lundi, j'ai un match de soccer.", impostor: "Sur lundi, j'ai un match de soccer." },
            { correct: "J'ai regard√© un film √† la t√©l√©vision.", impostor: "J'ai regard√© un film sur la t√©l√©vision." },
            { correct: "Je n'ai pas de crayon.", impostor: "Je n'ai pas un crayon." },
            { correct: "J'ai chaud. Est-ce que je peux avoir un verre d'eau?", impostor: "Je suis chaud. Est-ce que je peux avoir un verre de l'eau?" },
            { correct: "Qu'est-ce que tu fais ici? Oh, rien du tout!", impostor: "Quoi est-ce que tu fais ici? Oh, rien!" },
            { correct: "Quelle heure est-il?", impostor: "Quel temps est-il?" },
            { correct: "Je vais chez le m√©decin.", impostor: "Je vais au m√©decin." },
            { correct: "Je suis all√© √† Victoria.", impostor: "J'ai all√© √† Victoria." },
            { correct: "J'ai peur et j'ai froid.", impostor: "J'ai peur et je suis froid." },
            { correct: "Je l'aime parce qu'il est le meilleur.", impostor: "Je l'aime lui parce qu'il est le meilleur." },            
        ];


        const crewmateData = [
            {name: 'Rouge', color: '#D71E22'}, {name: 'Bleu', color: '#1D3CE9'},
            {name: 'Vert', color: '#1B913E'}, {name: 'Rose', color: '#FF63D4'},
            {name: 'Orange', color: '#FF8D1C'}, {name: 'Jaune', color: '#FFFF67'},
            {name: 'Noir', color: '#4A565E'}, {name: 'Blanc', color: '#E9F7FF'},
            {name: 'Violet', color: '#783DD2'}, {name: 'Marron', color: '#80582D'},
            {name: 'Cyan', color: '#44FFF7'}, {name: 'Citron', color: '#5BFE4B'},
            {name: 'Bordeaux', color: '#6C2B3D'}, {name: 'Chair', color: '#FFD6EC'},
            {name: 'Banane', color: '#FFFFBE'}
        ];

        const violentDeathPhrases = [
            "ARGH!",
            "GLOUPS!",
            "A√èEEE!",
            "OUGH!",
            "URGH!",
            "TCHAC!"
        ];

        const innocentEjectionPhrases = [
            "Non, pas moi!",
            "Je suis innocent!",
            "Vous vous trompez!",
            "J'esp√®re que les aliens sont sympas!",
            "Mais j'ai fait toutes mes t√¢ches!",
            "Vous le regretterez!",
            "Ce n'√©tait pas moi, je vous jure!",
            "Houston, on a un probl√®me!",
            "Eventuellement, j'ai arr√™t√© de penser...",
            "Dites √† ma famille que je les aime!",
            "C'√©tait pas moi, je le jure!",
            "That was kinda sus.",
            "it wasn't me :("
        ];

        const imposterEjectionPhrases = [
            "Au moins, je vais voir les √©toiles!",
            "Je reviendrai!",
            "√Ä bient√¥t, astronautes!",
            "Vive la gravit√© z√©ro!",
            "J'aurais d√ª rester au lit!",
            "Vous avez eu de la chance cette fois!",
            "Bien jou√©, les terriens!",
            "L'espace, me voil√†!",
            "Ma mission est accomplie!",
            "Merci pour cette partie!",
            "On se revoit dans l'espace infini!",
            "GG les amis!",
            "Eventuellement, Kars a arr√™t√© de penser..."
        ];

        function getRandomDeathPhrase(deathType) {
            let phrases;
            switch(deathType) {
                case 'violent':
                    phrases = violentDeathPhrases;
                    break;
                case 'innocent_ejected':
                    phrases = innocentEjectionPhrases;
                    break;
                case 'impostor_ejected':
                    phrases = imposterEjectionPhrases;
                    break;
                default:
                    phrases = violentDeathPhrases;
            }
            return phrases[Math.floor(Math.random() * phrases.length)];
        }

        let gameState = { crewmates: [], impostors: [], round: 1, gameOver: false, currentDeadCrewmate: -1, currentEjectedCrewmate: -1, isRevealing: false, votingPhase: 'between_rounds', hasVoted: false, showingResults: false };
        let audioContext = null, clickBuffer = null;

        function initAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function createClickBuffer() {
            if (!audioContext || clickBuffer) return clickBuffer;
            const bufferSize = audioContext.sampleRate * 0.02;
            clickBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = clickBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                if (i < bufferSize * 0.1) output[i] = (Math.random() * 2 - 1) * Math.pow((bufferSize * 0.1 - i) / (bufferSize * 0.1), 2);
                else if (i < bufferSize * 0.3) output[i] = (Math.random() * 2 - 1) * 0.3 * Math.pow((bufferSize * 0.3 - i) / (bufferSize * 0.2), 3);
                else output[i] = 0;
            }
            return clickBuffer;
        }

        function scheduleClick(time) {
            if (!audioContext || !clickBuffer) return;
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            source.buffer = clickBuffer;
            filter.type = 'highpass';
            filter.frequency.value = 2000;
            filter.Q.value = 1;
            gainNode.gain.value = 0.15;
            source.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start(time);
        }

        function revealTextWithSync(element, text, onComplete) {
            if (gameState.isRevealing) return;
            gameState.isRevealing = true;
            initAudio();
            createClickBuffer();
            element.innerHTML = '<span class="reveal-text"></span>';
            const textSpan = element.querySelector('.reveal-text');
            const charTimings = [];
            let currentTime = 0;
            for (let i = 0; i < text.length; i++) {
                charTimings.push(currentTime);
                currentTime += (i >= 2 && text[i] === '.' && text[i-1] === '.' && text[i-2] === '.' && i < text.length - 1) ? 1200 : 60;
            }
            if (audioContext) {
                const startTime = audioContext.currentTime + 0.1;
                for (let i = 0; i < text.length; i++) scheduleClick(startTime + charTimings[i] / 1000);
            }
            let startTimestamp = null, currentIndex = 0;
            function animate(timestamp) {
                if (!startTimestamp) startTimestamp = timestamp;
                const elapsed = timestamp - startTimestamp;
                while (currentIndex < text.length && elapsed >= charTimings[currentIndex]) {
                    textSpan.innerHTML = text.substring(0, ++currentIndex);
                }
                if (currentIndex < text.length) requestAnimationFrame(animate);
                else { gameState.isRevealing = false; if (onComplete) onComplete(); }
            }
            requestAnimationFrame(animate);
        }

        function initializeGame() {
            gameState = { crewmates: [], impostors: [], round: 1, gameOver: false, currentDeadCrewmate: -1, currentEjectedCrewmate: -1, isRevealing: false, votingPhase: 'game_start', hasVoted: false, showingResults: false };
            document.querySelector('.vote-title').innerHTML = 'French Grammar Impostors';
            document.getElementById('voteInstructions').innerHTML = 'Les imposteurs tentent de d√©truire la langue fran√ßaise avec la grammaire anglaise.<br><br>√âliminez les imposteurs. Vive l\'Alliance Fran√ßaise !';
            const shuffledPairs = [...phrasePairs].sort(() => Math.random() - 0.5);
            const shuffledCrewmateData = [...crewmateData].sort(() => Math.random() - 0.5);

            // Track which phrase pairs are used by crewmates
            const usedPairIndices = new Set();

            // Assign 10 crewmates, each with a different phrase pair
            for (let i = 0; i < 10; i++) {
                gameState.crewmates.push({
                    id: i, phrase: shuffledPairs[i].correct, isImpostor: false,
                    alive: true, ejected: false, color: shuffledCrewmateData[i].color,
                    name: shuffledCrewmateData[i].name, pairIndex: i
                });
                usedPairIndices.add(i);
            }

            // Create list of unused pairs for impostor priority assignment
            const unusedPairIndices = [];
            for (let i = 10; i < shuffledPairs.length; i++) {
                unusedPairIndices.push(i);
            }

            // Shuffle unused pairs for random selection
            unusedPairIndices.sort(() => Math.random() - 0.5);

            // Track which pairs have been assigned to impostors to prevent duplicates
            const impostorUsedPairs = new Set();

            // Assign 5 impostors using the prioritized system
            for (let impostorIndex = 0; impostorIndex < 5; impostorIndex++) {
                const crewmateId = 10 + impostorIndex;
                let pairIndex;

                // Priority 1: Use unused pairs if available
                if (unusedPairIndices.length > 0) {
                    pairIndex = unusedPairIndices.pop();
                } else {
                    // Priority 2: Reuse pairs already assigned to crewmates, but avoid duplicates among impostors
                    const usedIndicesArray = Array.from(usedPairIndices).filter(index => !impostorUsedPairs.has(index));

                    // If all crewmate pairs are already used by impostors, fall back to any crewmate pair
                    if (usedIndicesArray.length === 0) {
                        const allUsedIndices = Array.from(usedPairIndices);
                        pairIndex = allUsedIndices[Math.floor(Math.random() * allUsedIndices.length)];
                    } else {
                        pairIndex = usedIndicesArray[Math.floor(Math.random() * usedIndicesArray.length)];
                    }
                }

                // Track this pair as used by an impostor
                impostorUsedPairs.add(pairIndex);

                gameState.crewmates.push({
                    id: crewmateId, phrase: shuffledPairs[pairIndex].impostor,
                    correctPhrase: shuffledPairs[pairIndex].correct, isImpostor: true,
                    alive: true, ejected: false, color: shuffledCrewmateData[crewmateId].color,
                    name: shuffledCrewmateData[crewmateId].name, pairIndex: pairIndex
                });
                gameState.impostors.push(crewmateId);
            }

            updateDisplay();

            // Show the emergency button to start the game
            document.getElementById('voteButtons').innerHTML = `
                <br><button class="emergency-meeting-btn" onclick="startFirstEmergencyMeeting()">
                    <img src="Emergency_button.png" alt="Emergency Meeting Button">
                </button>
                <p>Appuyez sur le bouton d'urgence pour commencer !</p>
            `;
        }

        function startFirstEmergencyMeeting() {
            // Kill a random innocent crewmate first
            const aliveInnocents = gameState.crewmates.filter(c => c.alive && !c.ejected && !c.isImpostor);
            if (aliveInnocents.length > 0) {
                const victim = aliveInnocents[Math.floor(Math.random() * aliveInnocents.length)];
                victim.alive = false;
                victim.deathPhrase = getRandomDeathPhrase('violent');
                gameState.currentDeadCrewmate = victim.id;
                // Clear any previous ejected crewmate when starting the game
                gameState.currentEjectedCrewmate = -1;

                // Show the emergency meeting with dead crewmate info
                document.querySelector('.vote-title').innerHTML = 'üö® R√©union d\'urgence! üö®';
                document.getElementById('voteInstructions').innerHTML = `A crewmate has been killed!<br><br>
                    <div class="dead-crewmate-display">
                        <div class="dead-crewmate-body-small" style="background-color: ${victim.color}">‚ò†Ô∏è</div>
                        <strong>${victim.name}</strong>
                    </div><br>
                    Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>
                    Votez pour √©liminer celui que vous pensez √™tre un imposteur.`;

                // Play emergency meeting sound
                playEmergencyMeetingSound();

                // Enable voting
                gameState.hasVoted = false;
                gameState.votingPhase = 'emergency_meeting';

                // Update vote buttons area
                document.getElementById('voteButtons').innerHTML = '<p>Cliquez sur le bouton sous chaque personnage pour voter pour l\'√©liminer!</p>';

                updateDisplay();
            }
        }

        // SVG content for different crewmate states
        const crewmateSVGs = {
            alive: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="--crewmate-color: var(--current-color)"><path d="M27,11c0-1.3889-0.5712-2.6454-1.4888-3.5524C24.4883,4.8478,21.9586,3,19,3h-4c-3.8599,0-7,3.1401-7,7H7   c-1.6543,0-3,1.3457-3,3v8c0,1.6543,1.3457,3,3,3h1v1v1c0,1.6543,1.3457,3,3,3h2c1.6543,0,3-1.3457,3-3v-1.7693   c0.1204,0.0084,0.2469,0.0134,0.3804,0.0134c0.466,0,1.013-0.0637,1.6196-0.2253V26c0,1.6543,1.3457,3,3,3h2c1.6543,0,3-1.3457,3-3   v-1V13.9691C26.62,13.1364,27,12.1155,27,11z M25,11c0,1.6543-1.3457,3-3,3h-4c-1.6543,0-3-1.3457-3-3s1.3457-3,3-3h4   C23.6543,8,25,9.3457,25,11z M7,22c-0.5513,0-1-0.4487-1-1v-8c0-0.5513,0.4487-1,1-1h1v10H7z M24,26c0,0.5513-0.4487,1-1,1h-2   c-0.5513,0-1-0.4487-1-1v-2.8252c0.1821-0.1055,0.3664-0.2173,0.5547-0.3428c0.4595-0.3062,0.5835-0.9272,0.2773-1.3867   c-0.3071-0.4595-0.9272-0.5845-1.3867-0.2773c-2.3955,1.5981-3.9194,0.9727-4.0137,0.9302   c-0.007-0.0034-0.0146-0.0024-0.0217-0.0056c-0.0562-0.0255-0.1193-0.0314-0.1805-0.0463   c-0.0696-0.0167-0.1373-0.0402-0.2071-0.0418C15.0145,22.0043,15.0079,22,15,22c-0.0444,0-0.0822,0.0197-0.1251,0.0253   c-0.0797,0.0103-0.1581,0.0182-0.2327,0.047c-0.0546,0.0211-0.0991,0.0554-0.1486,0.0853   c-0.0597,0.0358-0.1196,0.0673-0.1712,0.1154c-0.0496,0.0461-0.0836,0.1033-0.123,0.1586   c-0.0299,0.0421-0.0701,0.0735-0.0939,0.1211c-0.0049,0.0098-0.0037,0.0206-0.0082,0.0305   c-0.0273,0.0591-0.0358,0.1247-0.0513,0.1893c-0.0157,0.0664-0.038,0.1307-0.0399,0.1974C14.0057,22.9805,14,22.9894,14,23v3   c0,0.5513-0.4487,1-1,1h-2c-0.5513,0-1-0.4487-1-1v-1v-2V11v-1c0-2.7568,2.2432-5,5-5h4c1.1193,0,2.1489,0.3755,2.9824,1H18   c-2.7568,0-5,2.2432-5,5s2.2432,5,5,5h4c0.7118,0,1.3864-0.1545,2-0.4238V25V26z M22,10c0-0.5523,0.4477-1,1-1s1,0.4477,1,1   c0,0.5522-0.4477,1-1,1S22,10.5522,22,10z M18,9h2c0.5522,0,1,0.4478,1,1s-0.4478,1-1,1h-2c-0.5522,0-1-0.4478-1-1S17.4478,9,18,9z   " fill="var(--crewmate-color, #000000)"/></svg>`,
            dead: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="--crewmate-color: var(--current-color)"><path d="M25,13h-5v-2.3082c1.1907-0.5569,1.9971-1.7797,1.9971-3.1909c0-1.9385-1.5234-3.5151-3.3965-3.5151   c-0.5605,0-1.1074,0.146-1.5977,0.4204c-0.4902-0.2744-1.0371-0.4204-1.5977-0.4204c-1.873,0-3.3965,1.5767-3.3965,3.5151   c0,1.4075,0.8036,2.6296,1.9912,3.1881V13h-4H6c-0.5527,0-1,0.4478-1,1v7.1733C5,22.7319,6.2686,24,7.8271,24H9v1v1v0.1733   C9,27.7319,10.2686,29,11.8271,29h2.3457C15.7314,29,17,27.7319,17,26.1733v-2.049c0.3054-0.0172,0.6393-0.0621,1-0.1461v2.1951   C18,27.7319,19.2686,29,20.8271,29h2.3457C24.7314,29,26,27.7319,26,26.1733V25V14C26,13.4478,25.5527,13,25,13z M9,22H7.8271   C7.3711,22,7,21.6294,7,21.1733V15h2V22z M15.9805,9.9807c-0.0006-0.4744-0.3209-0.8982-0.8047-0.9846   C14.5,8.875,14.0088,8.2466,14.0088,7.501c0-0.8354,0.626-1.5151,1.3965-1.5151c0.4209,0,0.7275,0.2065,0.9111,0.3799   c0.3848,0.3643,0.9883,0.3643,1.373,0c0.1836-0.1733,0.4902-0.3799,0.9111-0.3799c0.7705,0,1.3965,0.6797,1.3965,1.5151   c0,0.7349-0.5029,1.3779-1.1709,1.4956c-0.4843,0.0852-0.8057,0.5094-0.8064,0.9846H18V13h-2V9.9807H15.9805z M14,15h1h2v1h-1   c-0.5527,0-1,0.4478-1,1v1.5c0,0.2759-0.2246,0.5-0.5,0.5S14,18.7759,14,18.5V15z M24,25v1.1733C24,26.6294,23.6289,27,23.1729,27   h-2.3457C20.3711,27,20,26.6294,20,26.1733v-2.9988c0.1816-0.1038,0.3665-0.2171,0.5547-0.3425   c0.46-0.3062,0.584-0.9272,0.2773-1.3867c-0.3057-0.4595-0.9258-0.5845-1.3867-0.2773c-2.1357,1.4238-3.4941,0.8804-3.582,0.8428   c-0.4912-0.2339-1.0791-0.0332-1.3242,0.4556c-0.2471,0.4941-0.0469,1.0947,0.4473,1.3418   c0.0042,0.0021,0.0359,0.0151,0.0482,0.0208C15.0242,23.8866,15,23.9393,15,24v2.1733C15,26.6294,14.6289,27,14.1729,27h-2.3457   C11.3711,27,11,26.6294,11,26.1733V26v-1V15h1v3.5c0,1.3784,1.1211,2.5,2.5,2.5s2.5-1.1216,2.5-2.5V18c1.1025,0,2-0.897,2-2v-1h5   V25z" fill="var(--crewmate-color, #000000)"/></svg>`,
            ejected: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="--crewmate-color: var(--current-color)"><path d="M30,10.1548c-0.002-0.5811-0.2305-1.1265-0.6426-1.5352c-0.4131-0.4092-0.9551-0.6538-1.541-0.6294l-0.6104,0.0032   l1.6514-2.4783c0.4033-0.6724,0.4082-1.4897,0.0137-2.1875C28.415,2.521,27.5117,2,26.5703,2   c-0.6348,0-1.2314,0.2471-1.6797,0.6958L24.0039,3.582c-0.0537-0.1455-0.1221-0.2871-0.2061-0.4224   C23.3496,2.4336,22.5605,2,21.6885,2c-0.7432,0-1.4346,0.333-1.8984,0.9136l-2.7256,3.415   c-0.71,0.8882-1.0977,2.0034-1.0928,3.1396l0.0134,3.5599c-0.6112,0.62-0.9885,1.4714-0.985,2.4093l0.001,0.1621   c0.0029,0.9121,0.3613,1.7681,1.0088,2.4102c0.0358,0.0355,0.0784,0.0605,0.1155,0.0942c0.1561,0.7336,0.4616,1.3546,0.9392,1.8345   C17.7666,20.6431,18.7461,21,19.9727,21c0.0088,0,0.0186,0,0.0273,0h3.0039c2.5111-0.0107,4.0036-1.5056,3.9958-3.9955L27.8555,17   c1.1992-0.0063,2.1699-0.9863,2.1641-2.1846L30,10.1548z M18.4189,16.9995c-0.002,0-0.0039,0-0.0059,0   c-0.375,0-0.7285-0.1455-0.9941-0.4097c-0.2686-0.2656-0.417-0.6201-0.418-0.9995L17,15.4277   c-0.0029-0.7783,0.6279-1.4146,1.4072-1.418l2.1738-0.0093c0.0029,0,0.0049,0,0.0068,0c0.375,0,0.7285,0.1455,0.9941,0.4097   c0.2686,0.2656,0.417,0.6201,0.418,0.9995l0.001,0.1626c0.0029,0.7783-0.6279,1.4146-1.4063,1.418L18.4189,16.9995z M25,17.0039   c0.0059,1.3931-0.5938,1.9902-2,1.9961h-3.0039c-0.0373-0.0002-0.0682-0.0056-0.1045-0.0067l0.7119-0.0031   c1.8799-0.0083,3.4043-1.5449,3.3975-3.4277L24,15.4004c-0.0029-0.9121-0.3613-1.7681-1.0088-2.4102s-1.5127-0.9668-2.418-0.9897   l-2.1748,0.0093c0,0,0,0-0.001,0c-0.1425,0.0006-0.2781,0.0262-0.416,0.0439L17.9717,9.46   c-0.0029-0.6816,0.2295-1.3506,0.6553-1.8833l2.7256-3.415C21.4346,4.0591,21.5576,4,21.6885,4   c0.1738,0,0.3262,0.0786,0.4082,0.2109c0.0664,0.1069,0.0693,0.2217,0.0088,0.3418l-1,2c-0.2188,0.439-0.0879,0.9717,0.3096,1.2583   c0.3975,0.2871,0.9453,0.2422,1.292-0.104l3.5977-3.5972c0.249-0.2495,0.7031-0.0156,0.8262,0.2031   c0.1055,0.1855,0.0371,0.1333,0.0371,0.1323l-2,3C25.0586,7.6094,25,7.8027,25,8v0.8609c-0.0071,0.0487-0.0285,0.0923-0.0283,0.143   L25,16.0137V17.0039z M27.8457,15L27,15.0044V9.9945l0.8271-0.0043c0.001,0,0.001,0,0.001,0c0.0586,0,0.0986,0.0269,0.1211,0.0498   C27.9727,10.063,28,10.1021,28,10.1621l0.0195,4.6621C28.0195,14.9209,27.9414,14.9995,27.8457,15z M21,23c-0.5527,0-1,0.4478-1,1   v1c0,1.6543-1.3457,3-3,3c-1.1104,0-2.5244-0.2822-3.8535-0.7432C14.2549,26.3779,15,25.291,15,24c0-2.6631-2.5645-4-4-4   s-4,1.3369-4,4c0,1.291,0.7451,2.3779,1.8535,3.2568C7.5244,27.7178,6.1104,28,5,28H3c-0.5527,0-1,0.4478-1,1s0.4473,1,1,1h2   c1.4668,0,3.9004-0.4912,6-1.459C13.0996,29.5088,15.5332,30,17,30c2.7568,0,5-2.2432,5-5v-1C22,23.4478,21.5527,23,21,23z    M11,26.2993C9.8242,25.625,9,24.8164,9,24c0-1.3984,1.5176-2,2-2s2,0.6016,2,2C13,24.8164,12.1758,25.625,11,26.2993z" fill="var(--crewmate-color, #000000)"/></svg>`
        };

        function updateDisplay() {
            const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
            const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;

            const crewmatesArea = document.getElementById('crewmatesArea');
            const votingDisabled = gameState.votingPhase !== 'emergency_meeting' || gameState.hasVoted;
            crewmatesArea.innerHTML = gameState.crewmates.map(c => {
                // Determine speech bubble content and styling
                let speechContent = c.phrase;
                let isRecentlyDead = false;

                if (!c.alive && !c.ejected) {
                    // This crewmate is dead (killed by impostor)
                    if (c.id === gameState.currentDeadCrewmate) {
                        // This is the most recently killed crewmate - show death phrase
                        speechContent = c.deathPhrase || c.phrase;
                        isRecentlyDead = true;
                    } else {
                        // This is an old dead crewmate - speech will be hidden by CSS
                        speechContent = c.phrase;
                    }
                } else if (c.ejected) {
                    // This crewmate is ejected (voted out)
                    if (c.id === gameState.currentEjectedCrewmate) {
                        // This is the most recently ejected crewmate - show death phrase
                        speechContent = c.deathPhrase || c.phrase;
                        isRecentlyDead = true;
                    } else {
                        // This is an old ejected crewmate - speech will be hidden by CSS
                        speechContent = c.phrase;
                    }
                }

                // Determine which SVG to use
                let svgContent;
                if (c.alive && !c.ejected) {
                    svgContent = crewmateSVGs.alive;
                } else if (c.ejected) {
                    svgContent = crewmateSVGs.ejected;
                } else {
                    svgContent = crewmateSVGs.dead;
                }

                return `
                <div class="crewmate ${c.alive ? 'alive' : 'dead'} ${c.ejected ? 'ejected' : ''} ${isRecentlyDead ? 'recently-dead' : ''}">
                    <div class="crewmate-body" style="--current-color: ${c.color}; background-color: transparent;">
                        ${svgContent}
                    </div>
                    <div class="speech-bubble">${speechContent}</div>
                    <button class="vote-btn ${votingDisabled ? 'voting-disabled' : ''}"
                        style="background-color: ${c.color}; color: ${c.color === '#FFFFFF' || c.color === '#F5F557' ? '#000' : '#FFF'}"
                        onclick="vote(${c.id})" ${!c.alive || c.ejected || gameState.isRevealing || gameState.gameOver ? 'disabled' : ''}>
                        Voter ${c.name}
                    </button>
                </div>
                `;
            }).join('');

            const voteButtons = document.getElementById('voteButtons');
            const voteInstructions = document.getElementById('voteInstructions');
            if (gameState.gameOver) {
                voteButtons.innerHTML = '<p style="color: #4ecdc4;">Jeu termin√© - Aucun vote disponible</p>';
            } else if (gameState.isRevealing) {
                voteButtons.innerHTML = '';
            } else if (gameState.showingResults) {
                // Don't clear vote buttons when showing results - preserve the emergency button
            } else {
                if (gameState.currentDeadCrewmate !== -1) {
                    const dead = gameState.crewmates[gameState.currentDeadCrewmate];
                    voteInstructions.innerHTML = `Un co√©quipier est mort !<div class="dead-crewmate-display">
                        <div class="dead-crewmate-body-small" style="background-color: ${dead.color}">‚ò†Ô∏è</div>
                        <div style="color: ${dead.color === '#FFFFFF' || dead.color === '#F5F557' ? '#000' : '#FFF'}; font-weight: bold;">${dead.name}</div>
                    </div>Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.`;
                } else {
                    voteInstructions.innerHTML = 'Les imposteurs parlent fran√ßais avec la grammaire anglaise.<br><br>Votez pour √©liminer celui que vous pensez √™tre un imposteur.';
                }
                voteButtons.innerHTML = '';
            }
            checkGameEnd();
        }

        function vote(crewmateId) {
            if (gameState.isRevealing || gameState.gameOver || gameState.hasVoted || gameState.votingPhase !== 'emergency_meeting') return;
            gameState.hasVoted = true;
            gameState.votingPhase = 'vote_results';
            const votedCrewmate = gameState.crewmates[crewmateId];
            votedCrewmate.ejected = true;
            votedCrewmate.deathPhrase = getRandomDeathPhrase(votedCrewmate.isImpostor ? 'impostor_ejected' : 'innocent_ejected');
            
            // Clear the current dead crewmate and set the current ejected crewmate
            gameState.currentDeadCrewmate = -1;
            gameState.currentEjectedCrewmate = crewmateId;
            
            updateDisplay();
            startSuspensefulReveal(votedCrewmate);
        }

        function startSuspensefulReveal(votedCrewmate) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.querySelector('.vote-title').innerHTML = 'üìä R√©sultats du vote';

            // Clear vote buttons during reveal
            document.getElementById('voteButtons').innerHTML = '';

            // Start the suspenseful text reveal immediately
            let revealText = votedCrewmate.isImpostor
                ? `"${votedCrewmate.phrase}" utilise la grammaire anglaise...<br>Le fran√ßais correct est : "${votedCrewmate.correctPhrase}"...<br>${votedCrewmate.name} √©tait un imposteur.`
                : `"${votedCrewmate.phrase}" utilise les r√®gles de grammaire fran√ßaise...<br>${votedCrewmate.name} n'√©tait pas un imposteur.`;

            revealTextWithSync(document.getElementById('voteInstructions'), revealText, () => {
                // After reveal completes, update game state and show Next button
                if (votedCrewmate.isImpostor) gameState.impostors = gameState.impostors.filter(id => id !== votedCrewmate.id);
                gameState.round++;
                // Don't reset currentEjectedCrewmate here - keep it visible
                gameState.votingPhase = 'between_rounds';
                gameState.showingResults = true;  // Set flag to preserve emergency button

                // Show the Next button with updated stats
                const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
                const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;

                document.getElementById('voteButtons').innerHTML = `
                    <br><button class="emergency-meeting-btn" onclick="proceedToNextRound()"><img src="Emergency_button.png" alt="Emergency Meeting Button"></button>
                    <br><br>
                    <div class="game-stats">
                        <div class="stat">Imposteurs: <span id="impostorsLeft">${aliveImpostors}</span></div>
                        <div class="stat">Co√©quipiers: <span id="crewmatesLeft">${aliveInnocents}</span></div>
                        <div class="stat">Manche: <span id="round">${gameState.round}</span></div>
                    </div>
                `;
                updateDisplay();
            });
        }


        function proceedToNextRound() {
            // Kill next crewmate and start emergency meeting
            killNextCrewmate();
            startEmergencyMeeting();
        }

        function killNextCrewmate() {
            const aliveInnocents = gameState.crewmates.filter(c => c.alive && !c.ejected && !c.isImpostor);
            if (aliveInnocents.length > 0) {
                const victim = aliveInnocents[Math.floor(Math.random() * aliveInnocents.length)];
                victim.alive = false;
                victim.deathPhrase = getRandomDeathPhrase('violent');
                
                // Clear the previous ejected crewmate and set the new dead crewmate
                gameState.currentEjectedCrewmate = -1;
                gameState.currentDeadCrewmate = victim.id;
            }
        }

        function checkGameEnd() {
            const aliveImpostors = gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).length;
            const aliveInnocents = gameState.crewmates.filter(c => !c.isImpostor && c.alive && !c.ejected).length;
            const voteTitle = document.querySelector('.vote-title');
            const voteInstructions = document.getElementById('voteInstructions');
            
            if (aliveImpostors === 0) {
                voteTitle.innerHTML = 'üéâ Victory!';
                voteInstructions.innerHTML = 'Vous avez sauv√© la langue fran√ßaise des imposteurs anglais !<br><br><button class="new-game-btn" onclick="startNewGame()">Nouvelle Partie</button>';
                gameState.gameOver = true;
            } else if (aliveImpostors >= aliveInnocents) {
                voteTitle.innerHTML = 'üíÄ Game Over!';
                voteInstructions.innerHTML = `The grammar impostors have taken over! The remaining impostors were: ${gameState.crewmates.filter(c => c.isImpostor && c.alive && !c.ejected).map(c => c.name).join(', ')}<br><br><button class="new-game-btn" onclick="startNewGame()">Nouvelle Partie</button>`;
                gameState.gameOver = true;
            }
        }

        function startEmergencyMeeting() {
            // Play emergency meeting sound
            playEmergencyMeetingSound();

            // Reset voting state and enable voting
            gameState.hasVoted = false;
            gameState.votingPhase = 'emergency_meeting';
            gameState.showingResults = false;  // Reset flag when starting new meeting

            // Set up emergency meeting display (killing is now done in proceedToNextRound)
            document.querySelector('.vote-title').innerHTML = 'üö® R√©union d\'urgence! üö®';
            document.getElementById('voteButtons').innerHTML = '<p>Cliquez sur le bouton sous chaque personnage pour voter pour l\'√©liminer!</p>';
            updateDisplay();
        }

        function playEmergencyMeetingSound() {
            // Try to play the EmergencyMeetingSound.mp3 file
            const audio = new Audio('EmergencyMeetingSound.mp3');
            audio.volume = 0.1;
            audio.play().catch(error => {
                console.log('Could not play emergency meeting sound:', error);
            });
        }

        function startNewGame() { initializeGame(); }
        document.addEventListener('click', () => { if (audioContext && audioContext.state === 'suspended') audioContext.resume(); });
        initializeGame();
    </script>
</body>
</html>
<!-- Streamlined from 733 lines to 301 lines on 2025-09-25 -->